# ==============================================================================
# Zambezi Meats - OpenLiteSpeed Virtual Host Configuration
# ==============================================================================
# DEP-016: Configure OpenLiteSpeed vhost
# Virtual host with rewrite rules for SPA and API
# ==============================================================================
#
# Installation (CyberPanel):
#   1. Login to CyberPanel
#   2. Go to Websites > List Websites > your-domain > vHost Conf
#   3. Copy the relevant sections below
#
# Manual Installation:
#   1. Edit /usr/local/lsws/conf/vhosts/zambezimeats/vhconf.conf
#   2. Add/modify the sections below
#   3. Restart: /usr/local/lsws/bin/lswsctrl restart
#
# ==============================================================================

# ==============================================================================
# Main Virtual Host Configuration
# ==============================================================================

docRoot                   /var/www/zambezimeats/backend/current/public

# ==============================================================================
# Index Files
# ==============================================================================

index {
  useServer               0
  indexFiles              index.php, index.html
}

# ==============================================================================
# Error Pages
# ==============================================================================

errorlog /var/www/zambezimeats/logs/error.log {
  useServer               0
  logLevel                WARN
  rollingSize             10M
}

accesslog /var/www/zambezimeats/logs/access.log {
  useServer               0
  rollingSize             10M
  keepDays                30
}

# ==============================================================================
# Script Handler (PHP)
# ==============================================================================

scripthandler {
  add                     lsapi:lsphp82 php
}

# ==============================================================================
# PHP Settings
# ==============================================================================

phpIniOverride {
  php_value memory_limit 256M
  php_value upload_max_filesize 20M
  php_value post_max_size 25M
  php_value max_execution_time 60
  php_value max_input_time 60
  php_value max_input_vars 3000
  php_flag display_errors Off
  php_flag log_errors On
}

# ==============================================================================
# Security Headers
# ==============================================================================

context / {
  location                /var/www/zambezimeats/backend/current/public
  allowBrowse             1
  
  extraHeaders {
    set X-Frame-Options "SAMEORIGIN"
    set X-Content-Type-Options "nosniff"
    set X-XSS-Protection "1; mode=block"
    set Referrer-Policy "strict-origin-when-cross-origin"
    set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.paypal.com https://portal.afterpay.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.stripe.com https://www.paypal.com https://portal.afterpay.com; frame-src https://js.stripe.com https://www.paypal.com https://portal.afterpay.com;"
  }
  
  rewrite {
    enable                1
    autoLoadHtaccess      1
  }
}

# ==============================================================================
# API Routes Rewrite
# ==============================================================================

rewrite {
  enable                  1
  
  rules <<<END_RULES
# Remove trailing slashes
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [L,R=301]

# Handle Authorization Header
RewriteCond %{HTTP:Authorization} .
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

# Handle Front Controller (Laravel)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ index.php [L]

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirect www to non-www (or vice versa)
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
END_RULES
}

# ==============================================================================
# Static Files Caching
# ==============================================================================

context /build {
  location                /var/www/zambezimeats/backend/current/public/build
  allowBrowse             1
  
  expires {
    enableExpires         1
    expiresByType         text/css=A31536000
    expiresByType         application/javascript=A31536000
    expiresByType         application/json=A31536000
    expiresByType         image/png=A31536000
    expiresByType         image/jpeg=A31536000
    expiresByType         image/gif=A31536000
    expiresByType         image/webp=A31536000
    expiresByType         image/svg+xml=A31536000
    expiresByType         font/woff=A31536000
    expiresByType         font/woff2=A31536000
  }
  
  extraHeaders {
    set Cache-Control "public, max-age=31536000, immutable"
  }
}

context /storage {
  location                /var/www/zambezimeats/backend/current/public/storage
  allowBrowse             1
  
  expires {
    enableExpires         1
    expiresByType         image/png=A2592000
    expiresByType         image/jpeg=A2592000
    expiresByType         image/gif=A2592000
    expiresByType         image/webp=A2592000
  }
  
  extraHeaders {
    set Cache-Control "public, max-age=2592000"
  }
}

# ==============================================================================
# Gzip Compression
# ==============================================================================

gzip {
  enableGzip              1
  compressibleTypes       text/html, text/css, text/xml, text/plain, application/javascript, application/json, application/xml, application/xhtml+xml, image/svg+xml
}

# ==============================================================================
# SSL Configuration (DEP-004)
# ==============================================================================
# SSL is typically managed by CyberPanel automatically
# These settings enhance the default SSL configuration

# sslProtocol             24
# sslCiphers              ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

# ==============================================================================
# Rate Limiting (prevent abuse)
# ==============================================================================

perClientConnLimit {
  staticReqPerSec         50
  dynReqPerSec            20
  outBandwidth            0
  inBandwidth             0
  softLimit               1000
  hardLimit               1500
  blockBadReq             1
  gracePeriod             15
  banPeriod               60
}

# ==============================================================================
# Hotlink Protection (protect images)
# ==============================================================================

hotlinkCtrl {
  enable                  1
  suffixes                jpg, jpeg, png, gif, webp
  allowDirectAccess       1
  allowedHosts            zambezimeats.com.au, www.zambezimeats.com.au
  onlySelf                0
}
