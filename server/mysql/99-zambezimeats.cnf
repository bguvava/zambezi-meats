# ==============================================================================
# Zambezi Meats - MySQL 8.0 Production Configuration
# ==============================================================================
# DEP-006: Create MySQL database
# `my_zambezimeats` database created with secure user
#
# Optimized for:
# - 4GB RAM VPS
# - E-commerce workload (read-heavy, some writes)
# - InnoDB storage engine
# ==============================================================================
#
# Installation:
#   1. Copy to /etc/mysql/mysql.conf.d/99-zambezimeats.cnf
#   2. sudo chmod 644 /etc/mysql/mysql.conf.d/99-zambezimeats.cnf
#   3. sudo systemctl restart mysql
#
# ==============================================================================

[mysqld]
# ==============================================================================
# Basic Settings
# ==============================================================================
user = mysql
datadir = /var/lib/mysql
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid

# Character set
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# Timezone
default-time-zone = '+10:00'

# ==============================================================================
# Security
# ==============================================================================
# Bind only to localhost (no remote access)
bind-address = 127.0.0.1

# Disable symbolic links
symbolic-links = 0

# Secure file permissions
secure_file_priv = /var/lib/mysql-files

# Password policy (for new users)
validate_password.policy = MEDIUM
validate_password.length = 12

# ==============================================================================
# InnoDB Configuration (Primary Storage Engine)
# ==============================================================================
# Allocate ~60-70% of available RAM to InnoDB buffer pool
# For 4GB RAM server: 2.5GB buffer pool
innodb_buffer_pool_size = 2560M
innodb_buffer_pool_instances = 4

# Log file size (larger = better write performance, longer recovery)
innodb_log_file_size = 512M
innodb_log_buffer_size = 64M

# Flush method for better performance
innodb_flush_method = O_DIRECT

# Transaction durability (1 = full ACID, 2 = faster but risk 1s data loss)
innodb_flush_log_at_trx_commit = 1
sync_binlog = 1

# File per table (easier management, space reclaim)
innodb_file_per_table = ON

# I/O threads
innodb_read_io_threads = 8
innodb_write_io_threads = 4

# Redo log
innodb_redo_log_capacity = 1G

# ==============================================================================
# Connection & Thread Settings
# ==============================================================================
max_connections = 200
max_connect_errors = 100
wait_timeout = 300
interactive_timeout = 300
connect_timeout = 10

# Thread cache (reuse threads)
thread_cache_size = 50
thread_stack = 256K

# ==============================================================================
# Query Cache & Buffer Sizes
# ==============================================================================
# Note: Query cache is removed in MySQL 8.0, use Redis/application caching

# Sort and join buffers (per connection)
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 2M
read_rnd_buffer_size = 2M

# Temp tables
tmp_table_size = 64M
max_heap_table_size = 64M

# ==============================================================================
# Table & File Settings
# ==============================================================================
table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 65535

# ==============================================================================
# Binary Logging (for replication/point-in-time recovery)
# ==============================================================================
# Enable if using replication or need point-in-time recovery
# server-id = 1
# log_bin = /var/log/mysql/mysql-bin.log
# binlog_format = ROW
# binlog_expire_logs_seconds = 604800
# max_binlog_size = 256M

# ==============================================================================
# Slow Query Logging
# ==============================================================================
slow_query_log = ON
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 1
log_queries_not_using_indexes = ON
min_examined_row_limit = 100

# ==============================================================================
# General Logging (disable in production, enable for debugging)
# ==============================================================================
general_log = OFF
# general_log_file = /var/log/mysql/general.log

# ==============================================================================
# Error Logging
# ==============================================================================
log_error = /var/log/mysql/error.log
log_error_verbosity = 2

# ==============================================================================
# Performance Schema (useful for monitoring)
# ==============================================================================
performance_schema = ON
performance_schema_max_table_instances = 500

# ==============================================================================
# MyISAM (minimal, only for system tables)
# ==============================================================================
key_buffer_size = 32M
myisam_recover_options = BACKUP,FORCE

[mysqldump]
quick
quote-names
max_allowed_packet = 64M

[mysql]
no-auto-rehash
default-character-set = utf8mb4
