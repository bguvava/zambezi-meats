; ==============================================================================
; Zambezi Meats - Supervisor Configuration
; ==============================================================================
; DEP-012: Set up Laravel queue worker
; Queue worker running via Supervisor
; ==============================================================================
;
; Installation:
;   sudo apt install supervisor
;   sudo cp zambezimeats-worker.conf /etc/supervisor/conf.d/
;   sudo supervisorctl reread
;   sudo supervisorctl update
;   sudo supervisorctl start zambezimeats-worker:*
;
; ==============================================================================

[program:zambezimeats-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/zambezimeats/backend/current/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600 --queue=high,default,low
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/zambezimeats/logs/worker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=60

; ==============================================================================
; High Priority Queue Worker (payments, order processing)
; ==============================================================================

[program:zambezimeats-worker-high]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/zambezimeats/backend/current/artisan queue:work redis --sleep=1 --tries=5 --max-time=3600 --queue=high
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/zambezimeats/logs/worker-high.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=60

; ==============================================================================
; Scheduler Worker (runs scheduled tasks)
; ==============================================================================
; Note: This is NOT needed if using cron for scheduler
; Only use if you want Supervisor to handle the scheduler too

; [program:zambezimeats-scheduler]
; process_name=%(program_name)s
; command=php /var/www/zambezimeats/backend/current/artisan schedule:work
; autostart=true
; autorestart=true
; user=www-data
; numprocs=1
; redirect_stderr=true
; stdout_logfile=/var/www/zambezimeats/logs/scheduler.log
; stdout_logfile_maxbytes=10MB
; stdout_logfile_backups=3

; ==============================================================================
; Group Configuration
; ==============================================================================

[group:zambezimeats]
programs=zambezimeats-worker,zambezimeats-worker-high
priority=999
